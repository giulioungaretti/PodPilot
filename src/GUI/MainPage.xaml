<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="GUI.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:GUI"
    xmlns:controls="using:GUI.Controls"
    xmlns:models="using:DeviceCommunication.Models"
    xmlns:viewModels="using:PodPilot.Core.ViewModels"
    xmlns:converters="using:GUI.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">


    <Page.Resources>
        <!-- Reusable item template for device lists -->
        <DataTemplate x:Key="DeviceItemTemplate" x:DataType="viewModels:AirPodsDeviceViewModel">
            <controls:AirPodsCard Device="{x:Bind Mode=OneWay}" Margin="0,0,0,16"/>
        </DataTemplate>

        <!-- Reusable items panel for vertical stacking
             NOTE: The panel must be a Panel-derived element that the ItemsControl will use to host items.
             Scrolling is provided by wrapping the ItemsControl in a ScrollViewer where used. -->
        <ItemsPanelTemplate x:Key="DevicesItemsPanel">
            <ItemsStackPanel Orientation="Vertical" />
        </ItemsPanelTemplate>

        <!-- Reusable header used in both layouts -->
        <DataTemplate x:Key="PageHeaderTemplate">
            <StackPanel Spacing="8">
                <TextBlock Text="PodPilot" FontSize="32" FontWeight="Bold" />
                <TextBlock Text="Monitor your AirPods battery and status" Foreground="{ThemeResource TextFillColorSecondaryBrush}" FontSize="14" />
            </StackPanel>
        </DataTemplate>

        <!-- Reusable footer used in both states -->
        <DataTemplate x:Key="InfoFooterTemplate">
            <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                    CornerRadius="8"
                    Padding="12"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    MinWidth="280"
                    MaxWidth="520">
                <Grid VerticalAlignment="Center">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Icon column -->
                    <TextBlock Grid.Column="0" FontSize="16" Margin="0,0,12,0" VerticalAlignment="Center" FontFamily="Segoe UI Emoji">ðŸ’¡</TextBlock>

                    <!-- Text column -->
                    <StackPanel Grid.Column="1" Spacing="4" VerticalAlignment="Center">
                        <TextBlock FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextWrapping="Wrap">
                            Tip: Your AirPods don't need to be paired to view their status.
                        </TextBlock>
                        <TextBlock FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}" TextWrapping="Wrap">
                            They just need to be in range and broadcasting.
                        </TextBlock>
                    </StackPanel>
                </Grid>
            </Border>
        </DataTemplate>
    </Page.Resources>

    <Grid x:Name="PageRoot" Background="Transparent" Padding="40,20,40,40" MaxWidth="1200">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />      <!-- Header -->
            <RowDefinition Height="Auto" />      <!-- Paired Devices / Empty State -->
            <RowDefinition Height="*" />         <!-- Discovered Devices / Empty State -->
            <RowDefinition Height="Auto" />      <!-- Footer -->
        </Grid.RowDefinitions>

        <!-- Header -->
        <ContentControl Grid.Row="0" ContentTemplate="{StaticResource PageHeaderTemplate}" Margin="0,0,0,32" />

        <!-- Paired Devices Section -->
        <StackPanel Grid.Row="1" Spacing="16" Margin="0,0,0,32"
                    Visibility="{x:Bind ViewModel.HasPairedDevices, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <TextBlock Text="ðŸ”— Paired Devices" 
                           FontSize="20" 
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"
                           FontFamily="Segoe UI Emoji" />
            </Grid>

            <!-- Paired Devices List wrapped in ScrollViewer to enable scrolling -->
                <ItemsControl ItemsSource="{x:Bind ViewModel.PairedDevices, Mode=OneWay}"
                              ItemTemplate="{StaticResource DeviceItemTemplate}"
                              ItemsPanel="{StaticResource DevicesItemsPanel}" />
        </StackPanel>

        <!-- No Paired Devices Empty State -->
        <controls:EmptyState Grid.Row="1" 
                             Title="No paired devices"
                             Icon="ðŸŽ§" 
                             Message="Pair your AirPods in Windows Bluetooth settings to see them here"
                             ButtonText="Open Bluetooth Settings"
                             ButtonCommand="{x:Bind ViewModel.OpenBluetoothSettingsCommand}"
                             Margin="0,0,0,32"
                             Visibility="{x:Bind ViewModel.HasPairedDevices, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>

        <!-- Discovered Devices Section -->
        <StackPanel Grid.Row="2" Spacing="16" VerticalAlignment="Top"
                    Visibility="{x:Bind ViewModel.HasDiscoveredDevices, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <TextBlock Text="ðŸ“¡ Nearby Devices" 
                           FontSize="20" 
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"
                           FontFamily="Segoe UI Emoji" />
                
                <StackPanel Orientation="Horizontal" 
                            Spacing="12" 
                            HorizontalAlignment="Right"
                            Padding="15"
                            Visibility="{x:Bind ViewModel.IsScanning, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <controls:PulsatingDot IsActive="True" Size="20" />
                </StackPanel>
            </Grid>

            <!-- Discovered Devices List wrapped in ScrollViewer to enable scrolling -->
            <ScrollViewer HorizontalScrollBarVisibility="Disabled"
                          VerticalScrollBarVisibility="Auto"
                          MaxHeight="400"> <!-- optional MaxHeight to constrain scrolling area -->
                <ItemsControl ItemsSource="{x:Bind ViewModel.DiscoveredDevices, Mode=OneWay}"
                              ItemTemplate="{StaticResource DeviceItemTemplate}"
                              ItemsPanel="{StaticResource DevicesItemsPanel}" />
            </ScrollViewer>
        </StackPanel>

        <!-- No Discovered Devices Empty State -->
        <controls:EmptyState Grid.Row="2" 
                             Icon="ðŸ“¶" 
                             Title="No nearby devices"
                             Message="Open your AirPods case nearby to discover devices"
                             VerticalAlignment="Top"
                             Visibility="{x:Bind ViewModel.HasDiscoveredDevices, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>

        <!-- Footer -->
        <ContentControl Grid.Row="3" 
                        ContentTemplate="{StaticResource InfoFooterTemplate}" 
                        HorizontalAlignment="Center" 
                        VerticalAlignment="Bottom" />
    </Grid>
</Page>
